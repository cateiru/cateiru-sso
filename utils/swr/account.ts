import {api} from '../api';
import {HTTPError} from '../error';
import {
  AccountCertificatesSchema,
  AccountUserListSchema,
  AccountWebAuthnDevicesSchema,
} from '../types/account';
import {ErrorSchema} from '../types/error';

export async function accountUserFeather() {
  const res = await fetch(api('/account/list'), {
    credentials: 'include',
    mode: 'cors',
  });

  if (!res.ok) {
    const data = ErrorSchema.safeParse(await res.json());
    if (data.success) {
      throw data.data;
    }
    console.error(data.error.message);
    throw new HTTPError(data.error.message);
  }

  const data = AccountUserListSchema.safeParse(await res.json());
  if (data.success) {
    return data.data;
  }
  console.error(data.error.message);
  throw new HTTPError(data.error.message);
}

export async function userAccountCertificatesFeather() {
  const res = await fetch(api('/account/certificates'), {
    credentials: 'include',
    mode: 'cors',
  });

  if (!res.ok) {
    const data = ErrorSchema.safeParse(await res.json());
    if (data.success) {
      throw data.data;
    }
    console.error(data.error.message);
    throw new HTTPError(data.error.message);
  }

  const data = AccountCertificatesSchema.safeParse(await res.json());
  if (data.success) {
    return data.data;
  }
  console.error(data.error.message);
  throw new HTTPError(data.error.message);
}

export async function webAuthnDevicesFeather() {
  const res = await fetch(api('/account/webauthn'), {
    credentials: 'include',
    mode: 'cors',
  });

  if (!res.ok) {
    const data = ErrorSchema.safeParse(await res.json());
    if (data.success) {
      throw data.data;
    }
    console.error(data.error.message);
    throw new HTTPError(data.error.message);
  }

  const data = AccountWebAuthnDevicesSchema.safeParse(await res.json());
  if (data.success) {
    return data.data;
  }
  console.error(data.error.message);
  throw new HTTPError(data.error.message);
}
